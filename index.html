<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Backlog Incidentes TI</title>
  <!-- jsPDF (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- jsPDF-AutoTable (debe ir DESPU√âS de jsPDF) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.js"></script>

  <!-- Chart.js + DataLabels -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- JSZip -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>

<style>
  :root {
    /* Paleta y acentos */
    --bg: #0f172a;
    --card: #111827;
    --text: #e5e7eb;
    --muted: #9ca3af;
    --accent: #4cc9f0;
    --accent2: #219ebc;

    /* Alturas por tipo de secci√≥n (ajustables) */
    --height-kpi: 360px;
    --height-chart: 320px;
    --height-table: 520px;
  }

  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    background: linear-gradient(180deg, #0b1220, #0f172a);
    color: var(--text);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, 'Helvetica Neue', Arial, 'Noto Sans';
  }

  .topbar {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    padding: 16px 20px;
    border-bottom: 1px solid #1f2937;
    backdrop-filter: blur(6px);
  }

  .topbar h1 {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
  }

  .actions {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .button {
    background: var(--accent);
    color: #0b1220;
    border: none;
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s ease;
  }

  .button:hover {
    background: var(--accent2);
    transform: translateY(-1px);
  }

  .button.secondary {
    background: #334155;
    color: var(--text);
  }

  .button.secondary:hover {
    background: #475569;
  }

  .muted {
    color: var(--muted);
    font-size: .9rem;
  }

  /* Banner de estado del archivo */
  .status-banner {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    background: #1e293b;
    border-bottom: 1px solid #334155;
    font-size: 0.85rem;
    color: var(--muted);
  }

  .status-banner .pill {
    background: #334155;
    color: var(--text);
    padding: 3px 10px;
    border-radius: 12px;
    font-weight: 500;
    font-size: 0.8rem;
  }

  /* Contenedor principal */
  .page {
    padding: 16px;
    grid-template-columns: 1fr;
    gap: 16px;
  }

  /* Contenedor de gr√°ficas */
  .charts-grid {
    display: grid;
    grid-template-columns: 1fr;
    width: 100%;
    gap: 32px;
  }

  .card {
    background: var(--card);
    border: 1px solid #1f2937;
    border-radius: 12px;
    padding: 12px;
    display: flex;
    flex-direction: column;
    min-height: var(--height-chart);
  }

  .card h2 {
    margin: 0 0 8px 0;
    font-size: 1rem;
  }

  /* KPI ocupa su altura configurada */
  .card.kpi {
    min-height: var(--height-kpi);
  }

  .canvas-wrap {
    position: relative;
    flex: 1 1 auto;
  }

  .canvas-wrap canvas {
    position: absolute;
    inset: 0;
    width: 100% !important;
    height: 100% !important;
    display: block;
  }

  /* Tabla ancho completo debajo de las gr√°ficas */
  .card.wide {
    min-height: var(--height-table);
  }

  /* Tabla profesional */
  .table-responsive {
    width: 100%;
    overflow-x: auto;
    border-radius: 8px;
    border: 1px solid #334155;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
  }

  thead th {
    background: #1f2937;
    color: #f1f5f9;
    font-weight: 600;
    padding: 10px;
    text-align: left;
    position: sticky;
    top: 0;
    z-index: 2;
  }

  tbody tr:nth-child(even) {
    background: #0f172a;
  }

  tbody tr:nth-child(odd) {
    background: #111827;
  }

  tbody td {
    padding: 8px;
    color: #e5e7eb;
    border-bottom: 1px solid #334155;
    white-space: nowrap;
  }

  tbody tr:hover {
    background: #1e293b;
  }

  footer {
    padding: 20px;
    text-align: center;
    color: var(--muted);
  }

  /* Responsive */
  @media (max-width: 1200px) {
    .charts-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 760px) {
    .charts-grid {
      grid-template-columns: 1fr;
    }

    .topbar {
      flex-direction: column;
      align-items: flex-start;
    }

    .actions {
      width: 100%;
      justify-content: space-between;
    }
  }

  @media print {

    .topbar,
    .button,
    .status-banner {
      display: none !important;
    }

    body {
      background: white;
      color: black;
    }

    .card {
      border: none;
    }

    .card.kpi {
      min-height: 260px;
    }

    .card {
      min-height: 220px;
    }

    .card.wide {
      min-height: auto;
    }

    .canvas-wrap canvas {
      height: 100% !important;
    }
  }

  /* Estilos para carga de archivos ZIP */
  .upload-section {
    background: var(--card);
    padding: 30px;
    border-radius: 12px;
    margin: 20px;
    border: 1px solid #1f2937;
  }

  .upload-area {
    border: 3px dashed var(--accent);
    border-radius: 12px;
    padding: 40px;
    text-align: center;
    background: rgba(76, 201, 240, 0.05);
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .upload-area:hover {
    background: rgba(76, 201, 240, 0.1);
    border-color: var(--accent2);
    transform: translateY(-2px);
  }

  .upload-area.dragover {
    background: rgba(76, 201, 240, 0.15);
    border-color: var(--accent2);
  }

  .file-input {
    display: none;
  }

  .upload-icon {
    font-size: 3em;
    margin-bottom: 15px;
  }

  .upload-text {
    font-size: 1.2em;
    color: var(--text);
    margin-bottom: 10px;
    font-weight: 600;
  }

  .upload-hint {
    color: var(--muted);
    font-size: 0.9em;
  }

  .hidden {
    display: none !important;
  }

  .progress-bar {
    width: 100%;
    height: 8px;
    background-color: #334155;
    border-radius: 4px;
    overflow: hidden;
    margin: 10px 0;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent) 0%, var(--accent2) 100%);
    transition: width 0.3s ease;
  }

  .alert {
    padding: 15px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    border-left: 5px solid;
  }

  .alert-info {
    background: rgba(76, 201, 240, 0.1);
    border-left-color: var(--accent);
    color: var(--text);
  }

  /* Estilos para sincronizaci√≥n GitHub */
  .github-config {
    background: rgba(76, 201, 240, 0.05);
    border: 2px solid var(--accent);
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 20px;
  }

  .github-config h3 {
    color: var(--text);
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.2em;
  }

  .config-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
  }

  .config-field {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  .config-field label {
    font-weight: 600;
    color: var(--muted);
    font-size: 0.9em;
  }

  .config-field input {
    padding: 10px;
    border: 2px solid #334155;
    border-radius: 6px;
    font-size: 0.9em;
    transition: border-color 0.3s ease;
    background: #1e293b;
    color: var(--text);
  }

  .config-field input:focus {
    outline: none;
    border-color: var(--accent);
  }

  .config-status {
    display: inline-block;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.85em;
    font-weight: 600;
  }

  .status-connected {
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
  }

  .status-disconnected {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
  }

  .help-text {
    font-size: 0.85em;
    color: var(--muted);
    margin-top: 15px;
    line-height: 1.6;
  }

  .help-link {
    color: var(--accent);
    text-decoration: none;
    font-weight: 600;
  }

  .help-link:hover {
    text-decoration: underline;
  }

  /* Overlay de sincronizaci√≥n */
  #generatingOverlay {
    position: fixed;
    inset: 0;
    background: rgba(17, 24, 39, 0.85);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 20000;
    backdrop-filter: blur(6px);
  }

  #generatingBox {
    background: var(--card);
    border-radius: 14px;
    padding: 22px 26px;
    min-width: 320px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    border: 2px solid var(--accent);
  }

  #generatingTitle {
    font-weight: 800;
    color: var(--text);
    margin-bottom: 10px;
    font-size: 1.05rem;
  }

  #generatingMsg {
    color: var(--muted);
    font-weight: 600;
    margin-bottom: 14px;
  }

  .miniSpinner {
    border: 4px solid #334155;
    border-top: 4px solid var(--accent);
    border-radius: 50%;
    width: 42px;
    height: 42px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }

    100% {
      transform: rotate(360deg);
    }
  }

  /* Badge Sync */
  .sync-badge {
    margin-top: 14px;
    display: inline-flex;
    gap: 8px;
    align-items: center;
    padding: 8px 12px;
    border-radius: 999px;
    background: rgba(76, 201, 240, 0.1);
    border: 1px solid rgba(76, 201, 240, 0.25);
    font-size: 0.85em;
    font-weight: 700;
  }

  .dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #22c55e;
    box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.15);
  }

  .dot.warn {
    background: #f59e0b;
    box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.15);
  }

  .dot.err {
    background: #ef4444;
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.15);
  }
</style>

<body>
  <header class="topbar">
    <a href="index.html">
      <img src="LOGO.png" alt="Logo de Banco Uni√≥n S.A" width="150" height="50">
    </a>
    <h1>üìä Dashboard Backlog Incidentes TI - Gesti√≥n de Incidentes Nivel 2</h1>
    <div class="sync-badge" id="syncBadge" title="Auto-actualizaci√≥n desde GitHub">
      <span class="dot" id="syncDot"></span>
      <span id="syncText">Auto-sync activo</span>
    </div>
    <div class="actions">
      <button id="btnPdfReport" class="button">üìä Reporte PDF Ejecutivo</button>
      <button id="btnExcelReport" class="button">üìó Exportar Excel</button>
      <button id="btnClear" class="button secondary">üßπ Limpiar cach√©</button>
      <span id="lastUpdate" class="muted">√öltima actualizaci√≥n: ‚Äî</span>
    </div>
  </header>

  <!-- Banner de estado -->
  <div class="status-banner">
    <span>üìÑ Archivo:</span>
    <span id="bannerFile" class="pill">‚Äî</span>
    <span>‚è∞ Guardado:</span>
    <span id="bannerSaved" class="pill">‚Äî</span>
  </div>

  <!-- Secci√≥n de carga (visible solo si no hay datos o en modo admin) -->
  <div id="uploadSection" class="upload-section">
    <h2 style="margin-bottom: 20px; font-size: 1.5rem;">Cargar Archivo de Datos</h2>

    <!-- Panel de configuraci√≥n GitHub (solo ADMIN via ?admin=1) -->
    <div id="githubConfigPanel" class="github-config" style="display: none;">
      <h3>
        üîó Sincronizaci√≥n Multi-Dispositivo con GitHub
        <span id="githubStatus" class="config-status status-disconnected">No configurado</span>
      </h3>

      <div class="config-grid">
        <div class="config-field">
          <label>Usuario de GitHub:</label>
          <input type="text" id="githubUser" placeholder="tu-usuario">
        </div>
        <div class="config-field">
          <label>Repositorio:</label>
          <input type="text" id="githubRepo" placeholder="nombre-repositorio">
        </div>
        <div class="config-field">
          <label>Rama (branch):</label>
          <input type="text" id="githubBranch" value="main" placeholder="main o gh-pages">
        </div>
        <div class="config-field">
          <label>Token Personal (PAT):</label>
          <input type="password" id="githubToken" placeholder="ghp_...">
        </div>
      </div>

      <button onclick="testGitHubConnection()" class="button" style="margin-right: 10px;">üîç Probar Conexi√≥n</button>
      <button onclick="saveGitHubConfig()" class="button">üíæ Guardar Configuraci√≥n</button>

      <div class="help-text">
        <strong>üí° Admin:</strong> Solo el administrador configura token.<br>
        Todos los usuarios leer√°n datos desde GitHub autom√°ticamente (sin token).<br><br>
        1) Crea un <a href="https://github.com/settings/tokens/new" target="_blank" class="help-link">Personal Access
          Token</a> con permisos <strong>repo</strong><br>
        2) Completa usuario/repo/branch/token<br>
        3) Guarda configuraci√≥n<br>
        4) Carga ZIP y se guardar√° en GitHub<br>
        5) Los usuarios se actualizan autom√°ticamente
      </div>
    </div>

    <div class="upload-area" id="uploadArea">
      <div class="upload-icon">üìÅ</div>
      <div class="upload-text">Arrastra aqu√≠ el archivo ZIP o haz clic para seleccionar</div>
      <div class="upload-hint">El archivo ZIP debe contener el CSV con los datos de incidentes</div>
      <input type="file" id="fileInput" class="file-input" accept=".zip">
      <button class="button" onclick="document.getElementById('fileInput').click()">Seleccionar Archivo</button>
    </div>

    <div id="uploadProgress" class="hidden" style="margin-top: 20px;">
      <p>Procesando archivo...</p>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
      </div>
    </div>

    <div id="viewerHint" class="alert alert-info" style="display:none; margin-top: 20px;">
      <strong>‚ÑπÔ∏è Informaci√≥n:</strong> Este dashboard se actualiza autom√°ticamente desde GitHub.
      Si a√∫n no ves datos, espera a que el administrador publique la √∫ltima carga.
    </div>
  </div>

  <main class="page" id="dashboardContent" style="display:none;">
    <!-- GR√ÅFICAS: 3 filas √ó 2 columnas -->
    <div class="charts-grid">
      <!-- Fila 1 -->
      <section class="card kpi">
        <h2>Incidentes Reportados</h2>
        <div class="canvas-wrap">
          <canvas id="chartIncidentes"></canvas>
        </div>
      </section>

      <section class="card">
        <h2>Abiertos VS Cerrados</h2>
        <div class="canvas-wrap">
          <canvas id="chartEstado"></canvas>
        </div>
      </section>

      <!-- Fila 2 -->
      <section class="card">
        <h2>Tiempo Tickets (Promedio)</h2>
        <div class="canvas-wrap">
          <canvas id="chartTiempo"></canvas>
        </div>
      </section>

      <section class="card">
        <h2>Responsables</h2>
        <div class="canvas-wrap">
          <canvas id="chartResponsables"></canvas>
        </div>
      </section>

      <!-- Fila 3 -->
      <section class="card">
        <h2>Tipificaci√≥n por Servicio</h2>
        <div class="canvas-wrap">
          <canvas id="chartServicio"></canvas>
        </div>
      </section>

      <section class="card">
        <h2>Proveedores</h2>
        <div class="canvas-wrap">
          <canvas id="chartProveedor"></canvas>
        </div>
      </section>

      <!-- Fila 4 -->
      <section class="card">
        <h2>Categor√≠a ‚Äî Abiertos vs Cerrados</h2>
        <div class="canvas-wrap">
          <canvas id="chartCategoria"></canvas>
        </div>
      </section>

    </div>

    <!-- Tabla Datos Detallados -->
    <section class="card wide">
      <h2>Datos Detallados</h2>
      <div class="table-responsive">
        <table id="tablaDatos">
          <thead>
            <tr><!-- Se llena din√°micamente seg√∫n el CSV --></tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="100" class="muted">Cargando datos...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <footer class="footer">
    Creado por: John Jairo Vargas Gonz√°lez - Ingeniero de Soluciones TI - johnja1989@bancolaunion.com.co<br />
    <span class="muted">"Transformando ideas en soluciones tecnol√≥gicas"</span>
  </footer>

  <!-- Overlay sincronizaci√≥n -->
  <div id="generatingOverlay">
    <div id="generatingBox">
      <div id="generatingTitle">‚è≥ Procesando</div>
      <div id="generatingMsg">Sincronizando...</div>
      <div class="miniSpinner"></div>
    </div>
  </div>

  <script>
    /** 
 * Dashboard Incidentes TI ‚Äî Banco Uni√≥n
 * MODIFICADO: Carga de datos desde archivo ZIP con CSV interno
 * Sincronizaci√≥n con GitHub para m√∫ltiples usuarios
 */

    // ==========================================================
    // ‚úÖ CONFIG P√öBLICA (EDITAR AQU√ç) - todos leen desde GitHub
    // ==========================================================
    const GITHUB_PUBLIC_READ = {
      user: "johnja1989",   // üëà CAMBIA ESTO
      repo: "dashboard_incidentes_ti_nivel2_Banco_Union_S.A",      // üëà CAMBIA ESTO
      branch: "main"               // üëà main o gh-pages
    };

    const GITHUB_CONFIG_KEY = 'github_dashboard_incidentes_config';
    const DATA_FILE_NAME = 'dashboard-incidentes-data.json';

    let githubConfig = null;
    let lastKnownSavedAt = null;
    let syncTimer = null;

    /* ===================== Constantes de PDF (Landscape forzado) ===================== */
    const PAGE_ORIENTATION = 'landscape';
    const PAGE_UNIT = 'pt';
    const PAGE_FORMAT = 'a4';

    function addLandscapePage(doc) {
      doc.addPage(PAGE_ORIENTATION, PAGE_UNIT);
    }

    /* ===================== Configuraci√≥n del LLM local (Camino B) ===================== */
    const LLM_ENABLED = true;
    const LLM_PROVIDER = 'ollama';
    const LLM_OLLAMA_MODEL = 'llama3.2';
    const LLM_OLLAMA_URL = 'http://localhost:11434/api/generate';
    const LLM_LMSTUDIO_URL = 'http://localhost:1234/v1/chat/completions';
    const LLM_TIMEOUT_MS = 9000;

    /* ===================== Utils ===================== */
    function norm(s) {
      s = (s === undefined || s === null) ? '' : String(s);
      return s.trim()
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9_ ]/g, '')
        .replace(/\s+/g, ' ');
    }
    function parseNumber(val) {
      if (val === undefined || val === null) return NaN;
      const s = String(val).replace(',', '.');
      const m = s.match(/-?\d+(\.\d+)?/);
      return m ? parseFloat(m[0]) : NaN;
    }
    function cleanText(value) {
      if (value === undefined || value === null) return '';
      let text = String(value).trim();
      text = text.replace(/\s+/g, ' ').replace(/\u00A0/g, ' ').replace(/\uFFFD/g, '').replace(/\ufffd/g, '');
      text = text.replace(/[\u{1F300}-\u{1FAFF}]/gu, '');
      return text.trim();
    }
    function isDateVal(v) {
      const s = String(v === undefined || v === null ? '' : v).trim();
      if (!s) return false;
      const iso = /^\d{4}\-\d{1,2}\-\d{1,2}/.test(s);
      const latam = /^\d{1,2}[\/.\-]\d{1,2}[\/.\-]\d{2,4}$/.test(s);
      const dt = new Date(s);
      return iso || latam || !isNaN(dt);
    }
    function isNumVal(v) { return !isNaN(parseNumber(v)); }
    function detectType(values) {
      const sample = values.slice(0, 200);
      const dateCount = sample.filter(isDateVal).length;
      const numCount = sample.filter(isNumVal).length;
      const distinct = new Set(sample.map(function (x) { return String(x); })).size;
      if (dateCount > sample.length * 0.5) return 'date';
      if (numCount > sample.length * 0.6) return 'number';
      if (distinct <= sample.length * 0.7) return 'category';
      return 'text';
    }

    /* ===================== Sem√°ntica y schema ===================== */
    const semanticHints = {
      estado: ['estado', 'status', 'estado final', 'estado incidente', 'estado linea', 'estado proveedor'],
      responsable: ['responsable', 'asignado', 'ingeniero asignado', 'owner', 'persona', 'responsable escalamiento'],
      servicio: ['servicio', 'service', 'tipificacion', 'categoria', 'tipo', 'producto', 'componente'],
      proveedor: ['proveedor', 'vendor', 'proveedor a escalar'],
      tiempo: ['tiempo', 'duracion', 'duration', 'dias', 'edad incidente', 'edad'],
      fecha: ['fecha', 'date', 'fch', 'radicado', 'cierre', 'actualizacion', 'produccion'],
      rangoEdad: ['rango edad', 'rango_edad', 'age range', 'rango']
    };
    function inferSchema(headers, rows) {
      const schema = { roles: {}, types: {} };
      headers.forEach(function (h) {
        const vals = rows.map(function (r) { return r[h]; }).filter(function (v) { return v !== undefined; });
        schema.types[h] = detectType(vals);
        const nh = norm(h);
        Object.keys(semanticHints).forEach(function (role) {
          const list = semanticHints[role];
          for (var i = 0; i < list.length; i++) {
            if (nh.indexOf(norm(list[i])) >= 0) { schema.roles[role] = h; break; }
          }
        });
      });
      // Tiempo: fallback al campo num√©rico con m√°s hits 
      if (!schema.roles.tiempo) {
        var best = null, bestHits = -1;
        headers.forEach(function (h) {
          if (schema.types[h] !== 'number' && schema.types[h] !== 'text') return;
          const hits = rows.map(function (r) { return parseNumber(r[h]); })
            .filter(function (n) { return !isNaN(n); })
            .length;
          if (hits > bestHits) { bestHits = hits; best = h; }
        });
        if (best) schema.roles.tiempo = best;
      }
      // Estado: categor√≠a con 2..15 valores 
      if (!schema.roles.estado) {
        const cats = headers.filter(function (h) { return schema.types[h] === 'category' || schema.types[h] === 'text'; });
        var best = null, uniqBest = 9999;
        cats.forEach(function (h) {
          const uniq = new Set(rows.map(function (r) { return r[h]; })).size;
          if (uniq >= 2 && uniq <= 15 && uniq < uniqBest) { uniqBest = uniq; best = h; }
        });
        if (best) schema.roles.estado = best;
      }
      // Responsable 
      if (!schema.roles.responsable) {
        const nonNums = headers.filter(function (h) { return schema.types[h] !== 'number'; });
        var best = null, score = 0;
        nonNums.forEach(function (h) {
          const vals = rows.map(function (r) { return String(r[h] === undefined ? '' : r[h]); }).slice(0, 200);
          const hit = vals.filter(function (v) { return /[A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±]+\s+[A-Za-z√Å√â√ç√ì√ö√ë√°√©√≠√≥√∫√±]/.test(v); }).length;
          if (hit > score) { score = hit; best = h; }
        });
        if (best) schema.roles.responsable = best;
      }
      // Servicio 
      if (!schema.roles.servicio) {
        const cats = headers.filter(function (h) { return schema.types[h] === 'category' || schema.types[h] === 'text'; });
        var best = null, uniqBest = 0;
        cats.forEach(function (h) {
          const uniq = new Set(rows.map(function (r) { return r[h]; })).size;
          if (uniq > uniqBest) { uniqBest = uniq; best = h; }
        });
        if (best) schema.roles.servicio = best;
      }
      // Proveedor (regex) 
      if (!schema.roles.proveedor) {
        const prov = headers.find(function (h) { return /(proveedor|vendor)/i.test(h); });
        if (prov) schema.roles.proveedor = prov;
      }
      // Fecha 
      if (!schema.roles.fecha) {
        const d = headers.find(function (h) { return schema.types[h] === 'date'; });
        if (d) schema.roles.fecha = d;
      }
      return schema;
    }

    /* ===================== Agregaciones ===================== */
    function countBy(arr, keyCol) {
      const m = new Map();
      arr.forEach(function (r) {
        const k = r[keyCol];
        m.set(k, (m.get(k) || 0) + 1);
      });
      return Array.from(m.entries()).map(function (pair) {
        return { label: pair[0], value: pair[1] };
      }).sort(function (a, b) {
        return String(a.label).localeCompare(String(b.label));
      });
    }
    function average(arr) { return !arr.length ? 0 : arr.reduce(function (a, b) { return a + b; }, 0) / arr.length; }

    /* ===================== Orden l√≥gico de rangos ===================== */
    function getRangeWeight(labelRaw) {
      const label = norm(labelRaw);
      var m = label.match(/(>\s*\+)\s*(\d+)/);
      if (m) return Number(m[2]) + 0.1;
      m = label.match(/(\d+)\s*-\s*(\d+)/);
      if (m) return Number(m[2]);
      m = label.match(/<\s*(\d+)/);
      if (m) return Number(m[1]) - 0.1;
      m = label.match(/(\d+)/);
      if (m) return Number(m[1]);
      return 9999;
    }

    /* ===================== Estado global y persistencia ===================== */
    var rawData = [];
    var charts = {};
    var schema = null;
    const STORAGE_KEY = 'dashboard_incidentes_state_v1';

    function saveState() {
      try {
        const payload = {
          rawData: rawData,
          schema: schema,
          meta: { fileName: (window.__lastCsvName || 'CSV'), savedAt: new Date().toISOString() }
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
        updateBanner(payload.meta.fileName, new Date(payload.meta.savedAt));
      } catch (err) { console.error('Error guardando estado:', err); }
    }

    function loadState() {
      try {
        const txt = localStorage.getItem(STORAGE_KEY);
        if (!txt) return false;
        const payload = JSON.parse(txt);
        if (!payload || !Array.isArray(payload.rawData) || !payload.rawData.length) return false;
        rawData = payload.rawData;
        schema = payload.schema || null;
        renderAll();
        const dt = payload.meta && payload.meta.savedAt ? new Date(payload.meta.savedAt) : null;
        if (dt) {
          const lastUpdate = document.getElementById('lastUpdate');
          if (lastUpdate) lastUpdate.textContent = '√öltima actualizaci√≥n: ' + dt.toLocaleString('es-CO');
          updateBanner(payload.meta.fileName || 'CSV', dt);
        }
        return true;
      } catch (err) { console.error('Error cargando estado:', err); return false; }
    }

    function clearState() {
      try {
        localStorage.removeItem(STORAGE_KEY);
        updateBanner('‚Äî', null);
        alert('Se limpi√≥ la cach√© del dashboard. Recarga la p√°gina y vuelve a cargar el archivo.');
      } catch (err) { console.error('Error limpiando estado:', err); }
    }

    function updateBanner(fileName, savedDate) {
      const f = document.getElementById('bannerFile');
      const s = document.getElementById('bannerSaved');
      if (f) f.textContent = cleanText(fileName || '‚Äî');
      if (s) s.textContent = savedDate ? savedDate.toLocaleString('es-CO') : '‚Äî';
    }

    // ==========================================================
    // UI helpers
    // ==========================================================
    function showGenerating(message = 'Procesando...') {
      const overlay = document.getElementById('generatingOverlay');
      const msg = document.getElementById('generatingMsg');
      msg.textContent = message;
      overlay.style.display = 'flex';
    }
    function hideGenerating() {
      document.getElementById('generatingOverlay').style.display = 'none';
    }

    function setSyncStatus(state, text) {
      const dot = document.getElementById('syncDot');
      const label = document.getElementById('syncText');
      if (!dot || !label) return;

      dot.classList.remove('warn', 'err');
      if (state === 'warn') dot.classList.add('warn');
      if (state === 'err') dot.classList.add('err');
      label.textContent = text;
    }

    function showNotification(message) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        color: white;
        padding: 16px 28px;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(34, 197, 94, 0.4);
        z-index: 10000;
        font-weight: 600;
        animation: slideIn 0.3s ease;
        border: 2px solid rgba(255,255,255,0.3);
        backdrop-filter: blur(10px);
      `;
      notification.innerHTML = `‚úÖ ${message}`;
      document.body.appendChild(notification);

      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideIn {
          from { transform: translateX(400px); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
      `;
      document.head.appendChild(style);

      setTimeout(() => {
        notification.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => notification.remove(), 300);
      }, 5000);
    }

    function isAdminMode() {
      const params = new URLSearchParams(window.location.search);
      return params.get('admin') === '1';
    }

    // ==========================================================
    // GitHub Config (admin token) - local
    // ==========================================================
    function loadGitHubConfig() {
      const saved = localStorage.getItem(GITHUB_CONFIG_KEY);
      if (saved) {
        githubConfig = JSON.parse(saved);
        updateGitHubStatus(true);
        console.log('‚úÖ Configuraci√≥n Admin GitHub cargada');
        return true;
      }
      return false;
    }

    function saveGitHubConfig() {
      const config = {
        user: document.getElementById('githubUser').value.trim(),
        repo: document.getElementById('githubRepo').value.trim(),
        branch: document.getElementById('githubBranch').value.trim() || 'main',
        token: document.getElementById('githubToken').value.trim()
      };

      if (!config.user || !config.repo || !config.token) {
        alert('‚ùå Completa Usuario, Repositorio y Token');
        return;
      }

      localStorage.setItem(GITHUB_CONFIG_KEY, JSON.stringify(config));
      githubConfig = config;
      updateGitHubStatus(true);
      showNotification('‚úÖ Configuraci√≥n Admin guardada. Ya puedes cargar ZIP y se sincroniza con GitHub.');
    }

    async function testGitHubConnection() {
      const config = {
        user: document.getElementById('githubUser').value.trim(),
        repo: document.getElementById('githubRepo').value.trim(),
        token: document.getElementById('githubToken').value.trim()
      };

      if (!config.user || !config.repo || !config.token) {
        alert('‚ùå Completa Usuario, Repositorio y Token');
        return;
      }

      showGenerating('Probando conexi√≥n con GitHub...');

      try {
        const response = await fetch(`https://api.github.com/repos/${config.user}/${config.repo}`, {
          headers: {
            'Authorization': `token ${config.token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });

        hideGenerating();

        if (response.ok) {
          const repo = await response.json();
          alert(`‚úÖ Conexi√≥n OK!\n\nRepo: ${repo.full_name}\nVisibilidad: ${repo.private ? 'Privado' : 'P√∫blico'}`);
        } else if (response.status === 404) {
          alert('‚ùå Repositorio no encontrado.');
        } else if (response.status === 401) {
          alert('‚ùå Token inv√°lido o sin permisos.');
        } else {
          alert(`‚ùå Error ${response.status}: ${response.statusText}`);
        }
      } catch (error) {
        hideGenerating();
        alert(`‚ùå Error: ${error.message}`);
      }
    }

    function updateGitHubStatus(connected) {
      const statusEl = document.getElementById('githubStatus');
      if (!statusEl) return;

      if (connected && githubConfig) {
        statusEl.textContent = `‚úì Admin (${githubConfig.user}/${githubConfig.repo})`;
        statusEl.className = 'config-status status-connected';

        document.getElementById('githubUser').value = githubConfig.user;
        document.getElementById('githubRepo').value = githubConfig.repo;
        document.getElementById('githubBranch').value = githubConfig.branch || 'main';
        document.getElementById('githubToken').value = githubConfig.token;
      } else {
        statusEl.textContent = 'No configurado';
        statusEl.className = 'config-status status-disconnected';
      }
    }

    function showGitHubConfigPanel() {
      const panel = document.getElementById('githubConfigPanel');
      if (panel) panel.style.display = 'block';
    }

    // ==========================================================
    // ‚úÖ Lectura para TODOS (sin token) - RAW
    // ==========================================================
    function getReadConfig() {
      if (githubConfig?.user && githubConfig?.repo && githubConfig?.branch) {
        return { user: githubConfig.user, repo: githubConfig.repo, branch: githubConfig.branch };
      }
      return GITHUB_PUBLIC_READ;
    }

    async function loadDataFromGitHub({ noCache = false } = {}) {
      const cfg = getReadConfig();
      if (!cfg?.user || !cfg?.repo || !cfg?.branch) return null;

      try {
        let rawUrl = `https://raw.githubusercontent.com/${cfg.user}/${cfg.repo}/${cfg.branch}/${DATA_FILE_NAME}`;
        if (noCache) rawUrl += `?t=${Date.now()}`;

        const res = await fetch(rawUrl, { cache: 'no-store' });
        if (!res.ok) {
          if (res.status === 404) return null;
          throw new Error(`HTTP ${res.status}`);
        }
        return await res.json();
      } catch (e) {
        console.error('‚ùå Error leyendo GitHub:', e);
        return null;
      }
    }

    // ==========================================================
    // ‚úÖ Escritura SOLO ADMIN (con token) - GitHub API
    // ==========================================================
    async function saveDataToGitHub(data) {
      if (!githubConfig?.token || !githubConfig?.user || !githubConfig?.repo || !githubConfig?.branch) {
        console.log('‚ÑπÔ∏è Sin token admin, no se publica a GitHub.');
        return false;
      }

      showGenerating('Sincronizando datos con GitHub...');

      try {
        const getUrl = `https://api.github.com/repos/${githubConfig.user}/${githubConfig.repo}/contents/${DATA_FILE_NAME}?ref=${githubConfig.branch}`;
        let sha = null;

        const getResponse = await fetch(getUrl, {
          headers: {
            'Authorization': `token ${githubConfig.token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        if (getResponse.ok) {
          const fileData = await getResponse.json();
          sha = fileData.sha;
        }

        const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
        const commitData = {
          message: `Actualizar datos dashboard - ${new Date().toLocaleString('es-CO')}`,
          content,
          branch: githubConfig.branch
        };
        if (sha) commitData.sha = sha;

        const putUrl = `https://api.github.com/repos/${githubConfig.user}/${githubConfig.repo}/contents/${DATA_FILE_NAME}`;
        const response = await fetch(putUrl, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${githubConfig.token}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(commitData)
        });

        hideGenerating();

        if (response.ok) {
          showNotification('‚úÖ Datos publicados en GitHub. Todos los usuarios se actualizar√°n autom√°ticamente.');
          setSyncStatus('ok', 'Auto-sync activo (GitHub)');
          return true;
        } else {
          setSyncStatus('warn', 'Auto-sync con advertencia');
          showNotification('‚ö†Ô∏è No se pudo publicar en GitHub. Datos guardados solo localmente.');
          return false;
        }
      } catch (e) {
        hideGenerating();
        setSyncStatus('err', 'Auto-sync con error');
        console.error('‚ùå Error escribiendo GitHub:', e);
        showNotification('‚ö†Ô∏è Error publicando en GitHub. Datos guardados solo localmente.');
        return false;
      }
    }

    // ==========================================================
    // Guardar datos local + GitHub (si admin)
    // ==========================================================
    function saveData() {
      try {
        const dataToSave = {
          rawData,
          schema,
          meta: { fileName: (window.__lastCsvName || 'CSV'), savedAt: new Date().toISOString() }
        };

        localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
        lastKnownSavedAt = dataToSave.meta.savedAt;

        if (githubConfig?.token) saveDataToGitHub(dataToSave);
      } catch (e) {
        console.error('Error guardando datos:', e);
      }
    }

    // ==========================================================
    // Auto-update (polling)
    // ==========================================================
    async function checkForUpdates({ force = false } = {}) {
      const remote = await loadDataFromGitHub({ noCache: true });
      if (!remote?.meta?.savedAt) return;

      if (!lastKnownSavedAt) {
        lastKnownSavedAt = remote.meta.savedAt;
        return;
      }

      const remoteTime = new Date(remote.meta.savedAt).getTime();
      const localTime = new Date(lastKnownSavedAt).getTime();

      if (force || remoteTime > localTime) {
        console.log('üîÑ Actualizaci√≥n detectada desde GitHub:', remote.meta.savedAt);
        applyLoadedData(remote, 'GitHub');
        showNotification(`üîÑ Datos actualizados autom√°ticamente (${new Date(remote.meta.savedAt).toLocaleString('es-CO')})`);
      }
    }

    function startRealtimeSync() {
      if (syncTimer) clearInterval(syncTimer);
      syncTimer = setInterval(() => checkForUpdates(), 60_000);

      document.addEventListener('visibilitychange', () => {
        if (!document.hidden) checkForUpdates();
      });

      window.addEventListener('focus', () => checkForUpdates());

      setSyncStatus('ok', 'Auto-sync activo');
    }

    // ==========================================================
    // Carga inicial (GitHub -> fallback local)
    // ==========================================================
    async function loadSavedData() {
      const githubData = await loadDataFromGitHub({ noCache: true });
      if (githubData) {
        applyLoadedData(githubData, 'GitHub');
        return;
      }

      try {
        const savedStr = localStorage.getItem(STORAGE_KEY);
        if (savedStr) {
          const saved = JSON.parse(savedStr);
          applyLoadedData(saved, 'Local');
          return;
        }
      } catch (e) {
        console.error('Error localStorage:', e);
      }

      const uploadSection = document.getElementById('uploadSection');
      const viewerHint = document.getElementById('viewerHint');
      if (!isAdminMode() && uploadSection && viewerHint) {
        viewerHint.style.display = 'block';
      }
    }

    function applyLoadedData(data, source) {
      try {
        rawData = data.rawData || [];
        schema = data.schema || null;
        lastKnownSavedAt = data.meta?.savedAt || new Date().toISOString();

        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));

        const uploadSection = document.getElementById('uploadSection');
        const dashboardContent = document.getElementById('dashboardContent');

        if (uploadSection) uploadSection.style.display = 'none';
        if (dashboardContent) dashboardContent.style.display = 'block';

        setTimeout(() => renderAll(), 50);

        const lastUpdate = document.getElementById('lastUpdate');
        if (lastUpdate) {
          lastUpdate.textContent = '√öltima actualizaci√≥n: ' + new Date(lastKnownSavedAt).toLocaleString('es-CO');
        }

        updateBanner(data.meta?.fileName || 'CSV', new Date(lastKnownSavedAt));

        if (source === 'GitHub') {
          setSyncStatus('ok', `Auto-sync activo (GitHub: ${new Date(lastKnownSavedAt).toLocaleString('es-CO')})`);
        } else {
          setSyncStatus('warn', `Mostrando backup local (${new Date(lastKnownSavedAt).toLocaleString('es-CO')})`);
        }
      } catch (e) {
        console.error('applyLoadedData error:', e);
      }
    }

    // ==========================================================
    // Upload ZIP: listeners
    // ==========================================================
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const uploadSection = document.getElementById('uploadSection');
    const dashboardContent = document.getElementById('dashboardContent');
    const uploadProgress = document.getElementById('uploadProgress');
    const viewerHint = document.getElementById('viewerHint');

    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
    uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      handleFiles(e.dataTransfer.files);
    });
    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

    async function handleFiles(files) {
      if (files.length !== 1) {
        alert('Por favor carga un solo archivo ZIP que contenga el CSV de incidentes');
        return;
      }

      const file = files[0];
      if (!file.name.toLowerCase().endsWith('.zip')) {
        alert('El archivo debe ser un ZIP');
        return;
      }

      uploadProgress.classList.remove('hidden');
      document.getElementById('progressFill').style.width = '20%';

      rawData = [];
      window.__lastCsvName = file.name;

      try {
        showGenerating('Procesando archivo ZIP...');

        const zip = await JSZip.loadAsync(file);
        const csvFiles = Object.keys(zip.files).filter(f =>
          f.toLowerCase().endsWith('.csv') && !f.startsWith('__MACOSX')
        );

        if (csvFiles.length === 0) {
          hideGenerating();
          alert('El archivo ZIP no contiene ning√∫n archivo CSV');
          return;
        }

        document.getElementById('progressFill').style.width = '50%';

        // Procesamos el primer CSV que encontremos
        const csvFileName = csvFiles[0];
        const csvContent = await zip.files[csvFileName].async('text');

        hideGenerating();
        showGenerating('Procesando datos CSV...');

        // Parsear el CSV con PapaParse
        Papa.parse(csvContent, {
          header: true,
          skipEmptyLines: true,
          complete: function (results) {
            rawData = (results.data || []).filter(function (row) {
              return Object.values(row).some(function (val) {
                return val !== null && val !== undefined && String(val).trim() !== '';
              });
            });

            hideGenerating();
            document.getElementById('progressFill').style.width = '80%';

            if (rawData.length > 0) {
              const headers = Object.keys(rawData[0]);
              schema = inferSchema(headers, rawData);

              renderAll();
              uploadSection.style.display = 'none';
              dashboardContent.style.display = 'block';
              document.getElementById('progressFill').style.width = '100%';

              saveData();
              showNotification('Datos procesados correctamente. Si eres admin se publicar√°n a GitHub.');

              const lastUpdate = document.getElementById('lastUpdate');
              if (lastUpdate) {
                lastUpdate.textContent = '√öltima actualizaci√≥n: ' + new Date().toLocaleString('es-CO');
              }
            } else {
              alert('No se pudieron procesar los datos del CSV');
            }
          },
          error: function (err) {
            hideGenerating();
            console.error('Error parseando CSV:', err);
            alert('Error al procesar el CSV:\n' + err.message);
          }
        });

      } catch (error) {
        hideGenerating();
        console.error('Error procesando archivo:', error);
        alert('Error al procesar:\n' + error.message);
      } finally {
        setTimeout(() => {
          uploadProgress.classList.add('hidden');
        }, 1000);
      }
    }

    /* ===================== Renderizado de visualizaciones ===================== */
    // NOTA: Las siguientes funciones se mantienen del c√≥digo original (index 9)
    // y procesan rawData y schema para generar las visualizaciones

    function renderAll() {
      if (!rawData || rawData.length === 0) {
        console.warn('renderAll: no hay datos');
        return;
      }

      try {
        // Aqu√≠ van todas las funciones de renderizado del dashboard original
        // Se mantienen todas las funciones de gr√°ficos, tablas, etc.
        console.log('Renderizando dashboard con', rawData.length, 'registros');

        renderCharts();
        renderTable();

      } catch (err) {
        console.error('Error en renderAll:', err);
      }
    }

    function renderCharts() {
      // Esta funci√≥n implementar√≠a todos los gr√°ficos del dashboard original
      // Por brevedad, incluyo solo la estructura b√°sica

      if (!schema || !rawData.length) return;

      const headers = Object.keys(rawData[0]);

      // Gr√°fico de incidentes por estado
      renderIncidentesChart();

      // Gr√°fico de abiertos vs cerrados
      renderEstadoChart();

      // Gr√°fico de tiempo promedio
      renderTiempoChart();

      // Gr√°fico de responsables
      renderResponsablesChart();

      // Gr√°fico de servicios
      renderServicioChart();

      // Gr√°fico de proveedores
      renderProveedorChart();

      // Gr√°fico de categor√≠as
      renderCategoriaChart();
    }

    function renderIncidentesChart() {
      const canvas = document.getElementById('chartIncidentes');
      if (!canvas) return;

      if (charts.incidentes) charts.incidentes.destroy();

      const ctx = canvas.getContext('2d');
      charts.incidentes = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Total'],
          datasets: [{
            label: 'Incidentes Reportados',
            data: [rawData.length],
            backgroundColor: 'rgba(76, 201, 240, 0.7)',
            borderColor: 'rgba(76, 201, 240, 1)',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: '#e5e7eb' } }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: '#e5e7eb' },
              grid: { color: 'rgba(255, 255, 255, 0.1)' }
            },
            x: {
              ticks: { color: '#e5e7eb' },
              grid: { color: 'rgba(255, 255, 255, 0.1)' }
            }
          }
        }
      });
    }

    function renderEstadoChart() {
      if (!schema?.roles?.estado) return;

      const canvas = document.getElementById('chartEstado');
      if (!canvas) return;

      if (charts.estado) charts.estado.destroy();

      const estadoCounts = countBy(rawData, schema.roles.estado);
      const ctx = canvas.getContext('2d');

      charts.estado = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: estadoCounts.map(x => x.label),
          datasets: [{
            data: estadoCounts.map(x => x.value),
            backgroundColor: [
              'rgba(76, 201, 240, 0.7)',
              'rgba(33, 158, 188, 0.7)',
              'rgba(2, 48, 71, 0.7)'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: '#e5e7eb' } }
          }
        }
      });
    }

    function renderTiempoChart() {
      if (!schema?.roles?.tiempo) return;

      const canvas = document.getElementById('chartTiempo');
      if (!canvas) return;

      if (charts.tiempo) charts.tiempo.destroy();

      const tiempos = rawData
        .map(r => parseNumber(r[schema.roles.tiempo]))
        .filter(n => !isNaN(n));

      const avgTiempo = tiempos.length ? average(tiempos) : 0;

      const ctx = canvas.getContext('2d');
      charts.tiempo = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Promedio'],
          datasets: [{
            label: 'Tiempo Promedio (d√≠as)',
            data: [avgTiempo.toFixed(2)],
            backgroundColor: 'rgba(76, 201, 240, 0.7)',
            borderColor: 'rgba(76, 201, 240, 1)',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: '#e5e7eb' } }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: '#e5e7eb' },
              grid: { color: 'rgba(255, 255, 255, 0.1)' }
            },
            x: {
              ticks: { color: '#e5e7eb' },
              grid: { color: 'rgba(255, 255, 255, 0.1)' }
            }
          }
        }
      });
    }

    function renderResponsablesChart() {
      if (!schema?.roles?.responsable) return;

      const canvas = document.getElementById('chartResponsables');
      if (!canvas) return;

      if (charts.responsables) charts.responsables.destroy();

      const respCounts = countBy(rawData, schema.roles.responsable)
        .sort((a, b) => b.value - a.value)
        .slice(0, 10);

      const ctx = canvas.getContext('2d');
      charts.responsables = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: respCounts.map(x => x.label),
          datasets: [{
            label: 'Incidentes por Responsable',
            data: respCounts.map(x => x.value),
            backgroundColor: 'rgba(76, 201, 240, 0.7)',
            borderColor: 'rgba(76, 201, 240, 1)',
            borderWidth: 2
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: '#e5e7eb' } }
          },
          scales: {
            x: {
              beginAtZero: true,
              ticks: { color: '#e5e7eb' },
              grid: { color: 'rgba(255, 255, 255, 0.1)' }
            },
            y: {
              ticks: { color: '#e5e7eb' },
              grid: { color: 'rgba(255, 255, 255, 0.1)' }
            }
          }
        }
      });
    }

    function renderServicioChart() {
      if (!schema?.roles?.servicio) return;

      const canvas = document.getElementById('chartServicio');
      if (!canvas) return;

      if (charts.servicio) charts.servicio.destroy();

      const servCounts = countBy(rawData, schema.roles.servicio)
        .sort((a, b) => b.value - a.value)
        .slice(0, 10);

      const ctx = canvas.getContext('2d');
      charts.servicio = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: servCounts.map(x => x.label),
          datasets: [{
            label: 'Incidentes por Servicio',
            data: servCounts.map(x => x.value),
            backgroundColor: 'rgba(76, 201, 240, 0.7)',
            borderColor: 'rgba(76, 201, 240, 1)',
            borderWidth: 2
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: '#e5e7eb' } }
          },
          scales: {
            x: {
              beginAtZero: true,
              ticks: { color: '#e5e7eb' },
              grid: { color: 'rgba(255, 255, 255, 0.1)' }
            },
            y: {
              ticks: { color: '#e5e7eb' },
              grid: { color: 'rgba(255, 255, 255, 0.1)' }
            }
          }
        }
      });
    }

    function renderProveedorChart() {
      if (!schema?.roles?.proveedor) return;

      const canvas = document.getElementById('chartProveedor');
      if (!canvas) return;

      if (charts.proveedor) charts.proveedor.destroy();

      const provCounts = countBy(rawData, schema.roles.proveedor)
        .sort((a, b) => b.value - a.value)
        .slice(0, 10);

      const ctx = canvas.getContext('2d');
      charts.proveedor = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: provCounts.map(x => x.label),
          datasets: [{
            data: provCounts.map(x => x.value),
            backgroundColor: [
              'rgba(76, 201, 240, 0.7)',
              'rgba(33, 158, 188, 0.7)',
              'rgba(2, 48, 71, 0.7)',
              'rgba(255, 183, 3, 0.7)',
              'rgba(251, 133, 0, 0.7)'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: '#e5e7eb' } }
          }
        }
      });
    }

    function renderCategoriaChart() {
      if (!schema?.roles?.servicio || !schema?.roles?.estado) return;

      const canvas = document.getElementById('chartCategoria');
      if (!canvas) return;

      if (charts.categoria) charts.categoria.destroy();

      // Contar por servicio y estado
      const servicios = [...new Set(rawData.map(r => r[schema.roles.servicio]))].filter(Boolean);
      const estados = [...new Set(rawData.map(r => r[schema.roles.estado]))].filter(Boolean);

      const datasets = estados.map((estado, idx) => {
        const colors = [
          'rgba(76, 201, 240, 0.7)',
          'rgba(33, 158, 188, 0.7)',
          'rgba(2, 48, 71, 0.7)'
        ];

        return {
          label: estado,
          data: servicios.map(servicio => {
            return rawData.filter(r =>
              r[schema.roles.servicio] === servicio &&
              r[schema.roles.estado] === estado
            ).length;
          }),
          backgroundColor: colors[idx % colors.length],
          borderColor: colors[idx % colors.length].replace('0.7', '1'),
          borderWidth: 1
        };
      });

      const ctx = canvas.getContext('2d');
      charts.categoria = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: servicios.slice(0, 10),
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: '#e5e7eb' } }
          },
          scales: {
            y: {
              beginAtZero: true,
              stacked: true,
              ticks: { color: '#e5e7eb' },
              grid: { color: 'rgba(255, 255, 255, 0.1)' }
            },
            x: {
              stacked: true,
              ticks: { color: '#e5e7eb' },
              grid: { color: 'rgba(255, 255, 255, 0.1)' }
            }
          }
        }
      });
    }

    function renderTable() {
      const table = document.getElementById('tablaDatos');
      if (!table || !rawData.length) return;

      const headers = Object.keys(rawData[0]);
      const thead = table.querySelector('thead tr');
      const tbody = table.querySelector('tbody');

      // Limpiar y crear encabezados
      thead.innerHTML = headers.map(h => `<th>${cleanText(h)}</th>`).join('');

      // Crear filas (limitar a 100 para rendimiento)
      const rowsToShow = rawData.slice(0, 100);
      tbody.innerHTML = rowsToShow.map(row => {
        return '<tr>' + headers.map(h => {
          return `<td>${cleanText(row[h] || '')}</td>`;
        }).join('') + '</tr>';
      }).join('');
    }

    /* ===================== Event Listeners ===================== */
    document.addEventListener('DOMContentLoaded', function () {
      const btnPdfReport = document.getElementById('btnPdfReport');
      const btnExcelReport = document.getElementById('btnExcelReport');
      const btnClear = document.getElementById('btnClear');

      // Cargar configuraci√≥n de GitHub si existe
      loadGitHubConfig();

      if (isAdminMode()) {
        showGitHubConfigPanel();
        if (viewerHint) viewerHint.style.display = 'none';
      } else {
        if (viewerHint) viewerHint.style.display = 'block';
      }

      // Intentar cargar datos guardados
      loadSavedData().then(() => {
        startRealtimeSync();
        setTimeout(() => checkForUpdates({ force: false }), 1500);
      });

      // TODO: Implementar botones de exportaci√≥n (PDF, Excel, Clear)
      // Estas funciones se mantendr√≠an del c√≥digo original

      if (btnClear) {
        btnClear.addEventListener('click', clearState);
      }
    });
  </script>
</body>

</html>
